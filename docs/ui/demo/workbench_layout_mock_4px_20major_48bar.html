<!doctype html>
<html lang="en" data-dock="left">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>STL Manager ‚Ä¢ UI Mockup (Workbench Layout ‚Ä¢ 4px/20px/48px)</title>
    <style>
      :root {
        --frame-border: 18px;
        --drawer-top: 72px;
        --drawer-bottom: 24px;
        --tabs-gap: 16px; /* baked from tuner */
        --bar-row-h: 48px; /* fixed height for button rows */
        --bar-row-h-top: var(--bar-row-h); /* top row height (override here if needed) */
        /* How many major grid units wide should a top-row button be */
        --btn-major-cols: 8;
        /* Second row buttons width in major units (defaults to top-row value) */
        --btn2-major-cols: 5;
        --rail-w: 40px;   /* baked from tuner */
        --tab-size: 64px; /* baked from tuner */
        --tab-overhang: 36px;
        --bg-0: #0b0a07;
        --bg-1: #0f0e0a;
        --ink: #0c0a05;
        --panel-fill-top: #12100b;
        /* Topbar button art (supports decorative overhang) */
    --topbtn-img-inactive: url('../img/BtnTopbarInactive.png');   /* per user: this asset used when button is INACTIVE */
  /* Ambient info panel fixed bottom offset (simple, maintainable) */
        --ambient-bottom: 82px;
        --topbtn-img-active:   url('../img/BtnTopbarActive.png'); /* per user: this asset used when button is ACTIVE */
        --topbtn-pointer-h: 12px; /* overhang below the row; non-interactive */
        --topbtn-active-bgY: 100%; /* vertical scale of active art inside its pseudo-element */
        --panel-fill-bot: #17140d;
        --text: #e8e4d8;
        --muted: #bdb7a5;
        --accent: #d8b85a;
        --chip: #2a2618;
        --ok: #64d37f;
        --warn: #ffcc66;
        --err: #ee6666;
        /* Tab art assets from demo */
        --tab-img-inactive: url('../img/Tab2inactive.png');
        --tab-img-active: url('../img/Tab2.png');
        --tab-img-size: auto var(--tab-size);
        --tab-img-ratio: 2.6;
        --tab-img-width: calc(var(--tab-size) * var(--tab-img-ratio));
        /* Theme switcher background images */
        --theme-switch-bg-dark: url('../img/ComfyUI_14363_.png');
        /* Light-mode image */
        --theme-switch-bg-light: url('../img/ComfyUI_14835_.png');
        /* Workbench edge and padding controls */
        --wb-edge-top: 0px;
        --wb-edge-right: -300px;
        --wb-edge-bottom: 0px;
        --wb-edge-left: 0px;
        --wb-pad-v: 10px;
        --wb-pad-h: 12px;
        /* Fixed bottom inset for inspector panel */
        --inspector-bottom: 24px;
  /* Bottom inset for the inner inspector frame (visual edge control) */
  --inspector-frame-bottom: 56px; /* reserve space for notes/workflow footer */
      }
      html, body { height: 100%; margin: 0; }
      body {
        background:
          radial-gradient(1600px 1200px at 20% -10%, var(--bg-1) 0%, var(--bg-0) 72%, #070605 100%);
        color: var(--text);
        font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
        /* Constrain page-level scroll; internal panels will scroll */
        overflow: hidden;
      }
      h1, h2, h3 { font-family: "Cinzel", Georgia, serif; letter-spacing: 0.02em; margin: 0; }

      /* 9-slice ornate frame (match front_page_mock asset) */
      .frame {
        border: var(--frame-border) solid transparent;
        border-radius: 4px;
        --frame-img: url('../img/9sFrame3.png');
        --slice: 28;
        --biw: 1;
        --center-fill: #000;
        border-image-source: var(--frame-img);
        border-image-slice: var(--slice);
        border-image-width: var(--biw);
        border-image-repeat: stretch;
        background-color: var(--center-fill);
        background-clip: border-box;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.9), 0 10px 24px rgba(0,0,0,0.45);
        overflow: hidden; /* clip inner overflow, keep frame fully visible */
      }
      .frame .content { padding: 1px 1px; }

  /* Debug Grid Overlay (dev-only) */
  :root {
    --grid-u: 4px; /* base unit = 4px */
    --grid-major: 5; /* major every 5 units => 20px */
    --grid-minor-color: rgba(255,255,255,0.06);
    --grid-major-color: rgba(255,255,255,0.12);
    --grid-origin-x: 0px;
    --grid-origin-y: 0px;
  }
  body.debug-grid-on #gridOverlay { display: block; }
  #gridOverlay {
    position: fixed; inset: 0; pointer-events: none; z-index: 9999; display: none;
    background-position: var(--grid-origin-x) var(--grid-origin-y), var(--grid-origin-x) var(--grid-origin-y), var(--grid-origin-x) var(--grid-origin-y), var(--grid-origin-x) var(--grid-origin-y);
    background-image:
      linear-gradient(to bottom, transparent calc(var(--grid-u) - 1px), var(--grid-minor-color) 1px),
      linear-gradient(to right,  transparent calc(var(--grid-u) - 1px), var(--grid-minor-color) 1px),
      linear-gradient(to bottom, transparent calc((var(--grid-u) * var(--grid-major)) - 1px), var(--grid-major-color) 1px),
      linear-gradient(to right,  transparent calc((var(--grid-u) * var(--grid-major)) - 1px), var(--grid-major-color) 1px);
    background-size:
      var(--grid-u) var(--grid-u),
      var(--grid-u) var(--grid-u),
      calc(var(--grid-u) * var(--grid-major)) calc(var(--grid-u) * var(--grid-major)),
      calc(var(--grid-u) * var(--grid-major)) calc(var(--grid-u) * var(--grid-major));
  }
  /* Control panel */
  #gridCtrl { position: fixed; top: 8px; right: 8px; z-index: 10000; width: 280px; display: none; }
  body.debug-grid-on #gridCtrl { display: block; }
  #gridCtrl .content { display: grid; gap: 6px; }
  #gridCtrl .row { display: grid; grid-template-columns: auto 1fr 64px; align-items: center; gap: 6px; font-size: 12px; }
  #gridCtrl input[type="number"] { width: 64px; }
  #gridCtrl .row .wide { grid-column: 1 / -1; }
  #gridCtrl input[type="range"] { width: 100%; }
  #gridCtrl .actions { display: flex; gap: 6px; justify-content: flex-end; }
  #gridCtrl button { cursor: pointer; }

  /* Top bar (two-row button area + meta frame) */
  .topbar { position: sticky; top: 0; z-index: 5; }
  .topbar .content { display: grid; grid-template-columns: 180px 1fr; gap: 0; align-items: stretch; }
  .meta-card .title { font-family: "Cinzel", Georgia, serif; font-size: 18px; letter-spacing: 0.03em; }
  .meta-grid { display: grid; gap: 6px; margin-top: 6px; }
  .meta-grid .row { display: grid; grid-template-columns: 100px 1fr; gap: 6px; font-size: 12px; color: #d9d2bf; }

  .btn-area { display: grid; grid-template-rows: var(--bar-row-h-top) var(--bar-row-h) var(--bar-row-h); gap: 0; }
  .row-top { display: grid; grid-template-columns: 1fr auto auto; gap: 0; align-items: stretch; }
  .row-bottom { display: grid; grid-template-columns: 1fr; align-items: stretch; }
  .row-pins { display: flex; gap: 0; align-items: stretch; }
  .btnbar { display: flex; flex-wrap: nowrap; gap: 0; align-items: stretch; overflow: hidden; }
  /* Framed buttons using same 9-slice */
  .btn9 { --btn-frame-border: 12px; background: transparent; color: #f5e8b0; cursor: pointer; border: var(--btn-frame-border) solid transparent; border-radius: 4px; --frame-img: url('../img/9sFrame3.png'); --slice: 28; --biw: 1; border-image-source: var(--frame-img); border-image-slice: var(--slice); border-image-width: var(--biw); border-image-repeat: stretch; padding: 0 12px; line-height: 1; font-size: 14px; height: 100%; display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .btn9 { margin: 0; }
  .btnbar .btn9 + .btn9 { margin-left: -1px; }
  .btn9[aria-pressed="true"], .btn9.active { filter: brightness(1.05) contrast(1.04); }
  .btn9:focus-visible { outline: 2px solid #8ab4f8; outline-offset: 2px; }
  .btn9.small { padding: 0 10px; font-size: 13px; }

  /* Top row: make each domain button a fixed width = 5 major units
     major = var(--grid-u) * var(--grid-major); width = major * var(--btn-major-cols) */
  .row-top .btnbar .btn9 {
    flex: 0 0 calc(var(--grid-u) * var(--grid-major) * var(--btn-major-cols));
    width: calc(var(--grid-u) * var(--grid-major) * var(--btn-major-cols));
    box-sizing: border-box;
  }

  /* Second row: fixed width per button = --btn2-major-cols majors */
  .row-bottom .btnbar .btn9 {
    flex: 0 0 calc(var(--grid-u) * var(--grid-major) * var(--btn2-major-cols));
    width: calc(var(--grid-u) * var(--grid-major) * var(--btn2-major-cols));
    box-sizing: border-box;
  }

  /* Allow decorative overhang only for the top row */
  .row-top, .row-bottom, .row-pins { overflow: hidden; }
  .row-top { overflow: visible; position: relative; z-index: 2; }
  .row-top .btnbar { overflow: visible; }

  /* Top row button skins: add background art and anchor for overhang */
  .row-top .btnbar .btn9 {
    position: relative; /* anchor pseudo-element */
    overflow: visible;  /* allow ::after overhang to render */
    z-index: 3;         /* ensure it paints above the next row */
    background-image: var(--topbtn-img-inactive);
    background-repeat: no-repeat;
    background-position: center bottom;
    background-size: 100% 100%;
    /* Remove 9-slice frame for top row buttons */
    border: 0;
    border-image: none;
    border-radius: 0;
  }

  /* Top row: disable seam overlap since we removed frames */
  .row-top .btnbar .btn9 + .btn9 { margin-left: 0; }

  /* Active state art rendered via a full-height pseudo-element that can extend below the row.
     Layer it behind the button text using z-index; keep hitbox within the grid cell. */
  .row-top .btnbar .btn9[aria-pressed="true"] { background-image: none; }
  .row-top .btnbar .btn9[aria-pressed="true"]::after {
    content: "";
    position: absolute;
    left: 0; right: 0;
    bottom: calc(-1 * var(--topbtn-pointer-h));
    height: calc(100% + var(--topbtn-pointer-h));
    background-image: var(--topbtn-img-active);
    background-repeat: no-repeat;
    background-position: center bottom;
    background-size: 100% var(--topbtn-active-bgY);
    pointer-events: none; /* decorative only */
    z-index: -1; /* sit behind button text within its stacking context */
  }

  /* Banner-style dropdown menu (for saved collections) */
  .banner-menu { position: absolute; z-index: 10050; display: none; }
  .banner-menu.open { display: block; }
  .banner-menu .menu-frame {
    /* Banner skin: scales image to width, anchors tip at bottom */
  background-color: transparent; /* no fill behind transparent PNG */
    background-image: url('../img/menubanner1.png');
    background-repeat: no-repeat;
    background-size: 100% auto; /* scale to element width, preserve aspect */
    background-position: bottom center; /* keep pointed tip at bottom edge */
    border: 0px solid #2a281c;
    border-radius: 0;
    box-shadow: 0 10px 24px rgba(0,0,0,0.35);
  width: 100%;
  box-sizing: border-box;
  max-height: 320px;
  overflow: hidden;
    overscroll-behavior: contain; /* prevent scroll chaining affecting layout */
    overflow-anchor: none;        /* avoid scroll anchoring jumps */
    contain: layout paint;        /* isolate layout/paint to this element */
    /* Inner scroller will handle scroll */
  }
  .banner-menu .menu-scroll {
    max-height: 100%;
    overflow-y: auto;
    overscroll-behavior: contain;
    overflow-anchor: none;
    contain: layout paint;
    box-sizing: border-box;
    /* Reserve head/tail gap in the scrolling viewport so items never overlap the banner art */
    padding: 6px;
    padding-top: calc(6px + var(--banner-head-gap, 24px));
    padding-bottom: calc(6px + var(--banner-tail-gap, 16px));
  }
  .banner-menu .menu-scroll { scrollbar-width: none; -ms-overflow-style: none; }
  .banner-menu .menu-scroll::-webkit-scrollbar { display: none; }
  .banner-menu .menu-items {
    /* Items grid relies on scroller padding for outer spacing */
    padding: 0;
    display: grid;
    gap: 4px;
  }
  .banner-menu .menu-item { appearance: none; background: #1f1b12; color: #f5e8b0; border: 1px solid #3c3622; border-radius: 6px; padding: 8px 10px; text-align: left; cursor: pointer; font: inherit; }
  .banner-menu .menu-item:hover, .banner-menu .menu-item:focus { background: #241e13; outline: none; }

  

  /* Framed search and theme controls */
  .ctrl-frame { --frame-border: 12px; height: 100%; min-width: 220px; display: flex; box-sizing: border-box; }
  .ctrl-frame .content { display: flex; align-items: center; gap: 8px; width: 100%; height: 100%; box-sizing: border-box; }
  .ctrl-theme { min-width: 120px; width: auto; position: relative; cursor: pointer; }
  .ctrl-search { min-width: 260px; flex: 0 0 auto; }
  /* Make the (visually empty) button cover the whole frame for focus/ARIA, no visible text/icon */
  .theme-toggle { position: absolute; inset: 0; background: transparent; color: inherit; border: none; cursor: pointer; font-size: 0; }
  .theme-toggle:focus-visible { outline: 2px solid #8ab4f8; outline-offset: 2px; }
  .searchbox { width: 100%; }
  .searchbox input { width: 100%; height: 100%; background: #1a1811; color: var(--text); border: 1px solid #2a281c; border-radius: 8px; padding: 4px 10px; box-sizing: border-box; }
  /* Apply background art to the theme switcher frame based on current theme */
  html[data-theme="dark"] .ctrl-frame.ctrl-theme {
    background-image: var(--theme-switch-bg-dark);
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
    background-origin: border-box;
  }
  html[data-theme="light"] .ctrl-frame.ctrl-theme {
    background-image: var(--theme-switch-bg-light);
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
    background-origin: border-box;
  }
  /* Keep bottom rows clipped; top row overflow is handled above to allow decorative overhang */
  .row-bottom, .row-pins { overflow: hidden; }
  .chip { background: var(--chip); color: #efe5c8; border: 1px solid #3c3622; border-radius: 999px; padding: 6px 10px; font-size: 12px; }

      /* App grid: left overlay drawer, center workbench, right inspector */
  .app { max-width: 1440px; margin: 56px auto; padding: 0 16px 24px; }
  /* Fill viewport below top offset; prevent outer scroll */
  .appgrid { display: grid; grid-template-columns: minmax(0, 1fr) minmax(320px, 380px); gap: 16px; height: calc(100vh - var(--drawer-top) - var(--drawer-bottom)); overflow: hidden; }
  /* Workbench column occupies full height; allow internal scrolling */
  .workbench { height: 90%; min-height: 0; }
  .workbench > .frame { height: 100%; }
  /* Adjustable outer margins for the workbench frame */
  .workbench > .frame { margin: var(--wb-edge-top) var(--wb-edge-right) var(--wb-edge-bottom) var(--wb-edge-left); }
  .workbench > .frame > .content { display: grid; grid-template-rows: auto 1fr; padding: var(--wb-pad-v) var(--wb-pad-h); }
  /* Scroll area inside the workbench frame (beneath toolbar) */
  .workbench-inner { overflow: auto; min-height: 0; }
  /* Ensure nested grids can shrink for scroll container */
  .workbench-inner > div { min-height: 0; }
      /* Inspector: overlay fixed to viewport right; left aligned with search bar,
         top aligned with the workbench frame */
      .inspector {
        position: fixed;
        top: var(--inspector-top, calc(var(--drawer-top) + 8px));
        bottom: var(--inspector-bottom, 244px);
        right: 0;
        left: var(--inspector-left, calc(100vw - 380px)); /* fallback to ~380px width */
        z-index: 700;
      }
      /* Make the inner frame the visual element with its own bottom inset, without
         impacting other .frame instances elsewhere in the layout. */
      .inspector > .frame {
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        bottom: var(--inspector-frame-bottom, 0px);
      }
      /* Inspector content spacing and scroll */
  .inspector > .frame > .content { padding: 12px; overflow: auto; display: grid; gap: 8px; }

      /* Inspector footer: pinned notes/workflow + licensing area */
      .inspector > .frame > .insp-foot {
        position: absolute;
        left: 0; right: 0; bottom: 0;
        padding: 12px;
        display: grid; gap: 8px;
        box-sizing: border-box;
      }
      .insp-foot .frame { --frame-border: 12px; }
      .insp-foot .content { display: grid; gap: 8px; }
  .notes-box .title { font-family: "Cinzel", Georgia, serif; font-size: 14px; letter-spacing: 0.02em; color: #d9d2bf; }
      .notes-grid { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: start; }
      .notes-grid .textarea { width: 100%; height: 90px; background: #1a1811; color: var(--text); border: 1px solid #2a281c; border-radius: 8px; padding: 8px; box-sizing: border-box; resize: none; opacity: 0.85; }
      .notes-grid .textarea:disabled { color: #bdb7a5; }
      .checklist { display: grid; gap: 6px; align-content: start; }
      .checklist label { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #d9d2bf; opacity: 0.9; }
  .license-inline { display: grid; grid-template-columns: 84px 1fr; gap: 4px 8px; align-items: center; font-size: 11px; color: #cfc9b6; }
  .license-inline a { color: var(--gold-mid); text-decoration: none; }
  .license-inline a:hover { text-decoration: underline; }

      /* Inspector layout boxes (empty frames) */
      .insp-layout { display: grid; gap: 12px; }
      .ibox {
        --mini-border: 10px; --mini-slice: 28; --mini-biw: 1; --mini-img: url('../img/9sFrame3.png');
        border: var(--mini-border) solid transparent; border-radius: 4px;
        border-image-source: var(--mini-img); border-image-slice: var(--mini-slice); border-image-width: var(--mini-biw); border-image-repeat: stretch;
        background-color: var(--center-fill, #000); box-shadow: 0 0 0 1px rgba(0,0,0,0.85);
        min-height: 28px; box-sizing: border-box;
        /* Do not allow content to change box size */
        overflow: hidden;
        min-width: 0;
      }
      .ibox .label { font-size: 12px; color: var(--muted); padding: 6px 8px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .ibox.name { height: 60px; }

      /* Middle cluster: squares on sides + tall preview center */
  .midgrid { display: grid; grid-template-columns: 72px 1fr 72px; gap: 8px; align-items: stretch; }
  .midgrid > * { min-width: 0; }
  .sidecol { display: grid; gap: 18px; }
      .ibox.sq { width: 100%; height: 72px; }
      .preview .ibox.tall { height: 220px; }

      /* Actions row under preview */
  .actions-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .actions-row > * { min-width: 0; }
      .ibox.rect { height: 36px; }

      /* Favorite target indicator (visual only) */
      .ibox.rect.fav { position: relative; overflow: visible; }
      .fav-indicator {
        position: absolute;
        top: calc(-1 * var(--mini-border, 10px) + -8px);
        right: calc(-1 * var(--mini-border, 10px) + -8px);
        width: 36px; height: 36px;
        display: inline-flex; align-items: center; justify-content: center;
        background: transparent;
        background-image: url('../img/greenroundbutton.png');
        background-repeat: no-repeat; background-position: center; background-size: contain;
        color: #ffffff; font-weight: 700; font-size: 12px; line-height: 1;
        text-shadow: 0 1px 1px rgba(0,0,0,0.45);
        border-radius: 999px;
        pointer-events: none; /* graphics only */
        z-index: 5; /* hover above frame chrome */
      }
      .fav-indicator .txt { transform: translateY(-0.5px); }

  /* Saved panel: plain collection selector (no ornate frame) */
  .collection-box { background: #1a1811; border: 1px solid #2a281c; border-radius: 8px; padding: 6px; }
  .collection-list { display: grid; gap: 4px; max-height: 180px; overflow-y: auto; padding-right: 4px; scrollbar-width: none; -ms-overflow-style: none; }
  .collection-list::-webkit-scrollbar { display: none; }
  .collection-item { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 6px; cursor: pointer; color: var(--text); user-select: none; }
  .collection-item:hover { background: var(--chip); }
  .collection-item[aria-selected="true"], .collection-item.selected { background: var(--chip); outline: 1px solid rgba(216,184,90,0.35); }
  .collection-item .name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .collection-item .meta { font-size: 11px; opacity: 0.85; }

      /* Six wide metadata boxes */
  .insp-meta-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0px; }
  .insp-meta-grid > * { min-width: 0; }
      .insp-meta-grid .ibox.meta { height: 40px; }

      /* Files box */
  .ibox.files { min-height: 192px; position: relative; }
        /* Optional: inventory-like grid background (toggle by adding .grid-bg) */
        .ibox.files.grid-bg {
          --inv-grid-gap: 32px;                  /* cell size */
          --inv-grid-inset: 0px;                 /* padding from frame edge */
          --inv-grid-color: rgba(216,184,90,.16);/* subtle brass line */
        }
        .ibox.files.grid-bg::before {
          content: "";
          position: absolute;
          top: var(--inv-grid-inset); left: var(--inv-grid-inset);
          right: var(--inv-grid-inset); bottom: var(--inv-grid-inset);
          pointer-events: none;
          border-radius: 2px;
          background-image:
            linear-gradient(to bottom, var(--inv-grid-color) 1px, transparent 1px),
            linear-gradient(to right,  var(--inv-grid-color) 1px, transparent 1px);
          background-size: var(--inv-grid-gap) var(--inv-grid-gap);
        }

      /* Workbench toolbar and sidecar */
      .wb-toolbar { display: flex; gap: 10px; align-items: center; justify-content: space-between; margin-bottom: 10px; }
      .wb-left { display: flex; gap: 8px; align-items: center; }
      .wb-right { display: flex; gap: 8px; align-items: center; }
      .workbench-inner { display: grid; grid-template-columns: 1fr; gap: 12px; }
      .workbench.with-sidecar .workbench-inner { grid-template-columns: 1fr minmax(320px, 560px); }
      .sidecar { display: none; }
      .workbench.with-sidecar .sidecar { display: block; }

  /* Results grid/list */
  .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
  .card { min-height: 120px; }
  /* Table-like list view: no frames, 1px gold/brass separators between entries */
  .rowlist { display: grid; gap: 0; }
  .table-row { display: grid; grid-template-columns: 1fr auto; align-items: center; padding: 8px 12px; border: 2px solid var(--gold-darkest); }
  /* Avoid double-thick separators: keep first row's top border, remove top border on subsequent rows */
  .rowlist .table-row + .table-row { border-top: 0; }

      /* Inspector content placeholder */
      .kv { display: grid; grid-template-columns: 140px 1fr; gap: 6px; margin-bottom: 6px; }

      /* Drawer variables align with front_page_mock */
      :root {
        --drawer-w: 280px; /* baked from tuner */
        --tabs-offset: 24px; /* baked from tuner */
        --stem-w: 28px;
        --stem-offset: 10px;
        --tab-cap-overhang: 12px;
        --gold-darkest: #2b210a;
        --gold-dark: #533a0f;
        --gold-mid: #d8b85a;
        --gold-hi: #f2de8a;
        /* Drawer tab badge offsets */
        --tab-badge-right: 78px; /* distance from the right edge when docked left */
        --tab-badge-left: 76px;  /* distance from the left edge when docked right */
        --tab-badge-top: -4px;    /* distance from the top edge of the tab */
      }

      /* Drawer-attached tabs (visual layer below drawer for tuck-under) */
      .drawer-tabs { position: fixed; left: calc(-1 * var(--tab-cap-overhang)); top: calc(var(--drawer-top) + var(--tabs-offset)); display: flex; flex-direction: column; gap: var(--tabs-gap); z-index: 900; pointer-events: none; transition: left .22s ease, right .22s ease; }
      /* Hit layer: above drawer, captures clicks */
      .drawer-tabs-hit { position: fixed; left: calc(-1 * var(--tab-cap-overhang)); top: calc(var(--drawer-top) + var(--tabs-offset)); display: flex; flex-direction: column; gap: var(--tabs-gap); z-index: 1005; pointer-events: auto; transition: left .22s ease, right .22s ease; }
      .drawer-tab { position: relative; min-width: max(calc(var(--tab-overhang) + 28px), var(--tab-img-width)); height: var(--tab-size); padding: 0 12px 0 10px; display: inline-flex; align-items: center; justify-content: flex-start; cursor: pointer; border: 0; border-radius: 0 999px 999px 0; color: #2b210a; font-weight: 700; font-size: 14px; background: transparent; box-shadow: none; transition: transform .12s ease; }
      .drawer-tabs .drawer-tab::before, .drawer-tabs-hit .drawer-tab::before { content: ""; position: absolute; inset: 0; pointer-events: none; background-repeat: no-repeat; background-position: left center; background-size: var(--tab-img-size); }
      .drawer-tabs .drawer-tab::before { opacity: 1; background-image: var(--tab-img-inactive); }
      .drawer-tabs .drawer-tab.is-hover::before { background-image: var(--tab-img-active); }
      .drawer-tabs-hit .drawer-tab::before { opacity: 0; background-image: var(--tab-img-active); }
      .drawer-tabs-hit .drawer-tab[aria-pressed="true"]::before { opacity: 1; }
      .drawer-tab:focus-visible { outline: 2px solid #8ab4f8; outline-offset: 2px; }
      [data-dock="right"] .drawer-tabs .drawer-tab::before, [data-dock="right"] .drawer-tabs-hit .drawer-tab::before { transform: scaleX(-1); transform-origin: center; background-position: right center; }
      .drawer-tab .txt { pointer-events: none; }
      .drawer-tab .count {
        position: absolute;
        right: var(--tab-badge-right, 6px);
        top: var(--tab-badge-top, 4px);
        width: 32px;
        height: 32px;
        min-width: 32px;
        padding: 0;
        border-radius: 999px;
        background: transparent;
        background-image: url('../img/greenroundbutton.png');
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
        color: #ffffff;
        border: 0;
        font-size: 11px;
        line-height: 1;
        display: none;
        align-items: center;
        justify-content: center;
        pointer-events: none; /* ensure clicks go to the tab */
        text-shadow: 0 1px 1px rgba(0,0,0,0.45);
      }
      .drawer-tab.has-count .count { display: inline-flex; }

      /* Drawer and backdrop */
      .drawer-wrap { position: fixed; inset: 0; pointer-events: none; z-index: 900; }
      .drawer-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.35); opacity: 0; transition: opacity .2s ease; }
      .drawer { position: fixed; top: var(--drawer-top); bottom: var(--drawer-bottom); left: calc(-1 * (var(--drawer-w) + (var(--frame-border) * 2))); width: var(--drawer-w); max-width: calc(100vw - 48px); transition: left .22s ease; pointer-events: auto; overflow: visible; z-index: 950; }
      .drawer.open { left: 0; }
      .drawer-wrap.open .drawer-backdrop { opacity: 1; pointer-events: auto; }
      [data-dock="left"] .drawer.open + .drawer-tabs { left: calc(var(--drawer-w) + (var(--frame-border) * 2) - var(--tab-cap-overhang)); }
      [data-dock="left"] .drawer.open ~ .drawer-tabs-hit { left: calc(var(--drawer-w) + (var(--frame-border) * 2) - var(--tab-cap-overhang)); }
      [data-dock="right"] .drawer { left: auto; right: calc(-1 * (var(--drawer-w) + (var(--frame-border) * 2))); transition: right .22s ease; }
      [data-dock="right"] .drawer.open { right: 0; }
      [data-dock="right"] .drawer-tabs, [data-dock="right"] .drawer-tabs-hit { left: auto; right: calc(-1 * var(--tab-cap-overhang)); top: calc(var(--drawer-top) + var(--tabs-offset)); }
      [data-dock="right"] .drawer-tab { border-radius: 999px 0 0 999px; justify-content: flex-end; }
      [data-dock="right"] .drawer-tab .count { left: var(--tab-badge-left, 6px); right: auto; }
      [data-dock="right"] .drawer.open + .drawer-tabs { right: calc(var(--drawer-w) + (var(--frame-border) * 2) - var(--tab-cap-overhang)); left: auto; }
      [data-dock="right"] .drawer.open ~ .drawer-tabs-hit { right: calc(var(--drawer-w) + (var(--frame-border) * 2) - var(--tab-cap-overhang)); left: auto; }

      .drawer .header { display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 8px; padding: 10px 12px 6px; }
      .drawer .title { font-family: "Cinzel", Georgia, serif; letter-spacing: 0.02em; font-size: 18px; }
      .pin, .close { background: transparent; border: 0; color: #f5e8b0; font-size: 18px; cursor: pointer; padding: 4px 6px; border-radius: 6px; }
      .pin[aria-pressed="true"] { color: #9fe2b0; }
      .drawer .body { padding: 10px 12px 14px; max-height: calc(100% - 46px); overflow: auto; }
      .drawer .hint { color: #cfc9b6; font-size: 12px; margin-bottom: 8px; }
      .drawer .footer { position: sticky; bottom: 0; background: linear-gradient(var(--panel-fill-top), var(--panel-fill-bot)); padding: 8px 12px; display: flex; gap: 8px; justify-content: flex-end; border-top: 1px solid rgba(0,0,0,0.35); }
      .btn { padding: 6px 10px; border-radius: 6px; cursor: pointer; user-select: none; border: 1px solid #3c3622; color: #f5e8b0; background: #1f1b12; }
      .drawer-resize { position: absolute; top: 0; right: 0; width: 8px; bottom: 0; cursor: ew-resize; }

      .searchbox input { background: #1a1811; color: var(--text); border: 1px solid #2a281c; border-radius: 8px; padding: 8px 10px; min-width: 260px; }

      /* Utilities */
      .muted { color: var(--muted); }
      .badge { background: #2a2618; padding: 2px 6px; border-radius: 6px; font-size: 11px; }
      .spacer { height: 12px; }

  /* Drawer panels: show one at a time */
  .tabpanel { display: none; }
  .tabpanel.active { display: block; }
  /* List layout: vertical, no wrapping of labels */
  .filters-col { display: flex; flex-direction: column; gap: 6px; }
  .filters-col label { display: flex; align-items: center; gap: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .filters-col.scroll { max-height: 320px; overflow-y: auto; padding-right: 6px; }
  .searchbox.small input { min-width: 0; width: 100%; height: 32px; padding: 4px 8px; }

      /* Light theme overrides (copied from front_page_mock for consistency) */
      [data-theme="light"] {
        --bg-0: #efe9dc;
        --bg-1: #f7f3ea;
        --ink: #1f180b;
        --panel-fill-top: #faf6ec;
        --panel-fill-bot: #eee6d4;
        --gold-dark: #7a5719;
        --gold-mid: #c9a74b;
        --gold-hi: #f2de8a;
        --text: #2e2818;
        --muted: #5f5748;
        --accent: #b8912e;
        --chip: #efe7d5;
        --chip-hl: #e6dcc5;
        --ok: #2f8e4b;
        --warn: #b8821a;
        --err: #b23b3b;
      }
      /* Use a light inner fill for frames under light mode */
      [data-theme="light"] .frame { --center-fill: #f5efe3; }
      /* Inputs: lighten background/border in light mode */
      [data-theme="light"] .searchbox input {
        background: #f5efe3;
        color: var(--text);
        border-color: #cfc4ab;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.08);
      }
      /* Buttons (Grid/List, drawer actions) */
      [data-theme="light"] .btn { color: #2e2818; background: #efe7d5; border-color: #cdbd97; }
      /* Chips: ensure contrast like front_page_mock */
      [data-theme="light"] .chip { background: #f3ebd9; border-color: #c8b894; color: #2e2818; }

      /* Ambient info panel (background-like, non-interactive) */
      .ambient-info {
        position: fixed;
        top: var(--drawer-top);
        bottom: var(--ambient-bottom);
        left: 72px;
        width: calc(var(--drawer-w) - 0px);
        padding: 8px;
        z-index: 800; /* below drawer (950) and drawer tabs (900/1005) */
        pointer-events: none; /* non-interactive by design */
        border: 1px solid rgba(255,255,255,0.08);
      }
      html[data-dock="right"] .ambient-info { left: auto; right: 0; }
      .ambient-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 0px;
        padding: 10px 12px;
        color: var(--muted);
        font-size: 12px;
        line-height: 1.3;
        box-shadow: 0 6px 14px rgba(0,0,0,0.18) inset;
      }
      .ambient-card .title { font-family: "Cinzel", Georgia, serif; letter-spacing: 0.02em; font-size: 14px; color: #d9d2bf; opacity: 0.8; margin-bottom: 6px; }
      .ambient-rows { display: grid; gap: 4px; }
      .ambient-rows .row { display: grid; grid-template-columns: 64px 1fr; gap: 8px; color: #cfc9b6; opacity: 0.85; }
      .ambient-rows .row div:first-child { color: #bdb7a5; opacity: 0.8; }
      .ambient-foot { margin-top: 8px; font-size: 11px; color: #bdb7a5; opacity: 0.75; }
      /* Light theme: invert to low-contrast dark-on-light */
      [data-theme="light"] .ambient-card {
        background: rgba(0,0,0,0.03);
        border-color: rgba(0,0,0,0.08);
        color: var(--muted);
        box-shadow: 0 6px 14px rgba(0,0,0,0.06) inset;
      }
    </style>
  </head>
  <body>
    <!-- Top scope bar: Meta frame + two rows of framed buttons -->
    <div class="topbar">
      <div class="content">
        <!-- Meta frame (app info) -->
        <div class="frame meta-card">
          <div class="content">
            <div class="title">STL Manager</div>
            <div class="meta-grid">
              <div class="row"><div>DB</div><div>stl_manager_v1.db</div></div>
              <div class="row"><div>View</div><div>Workbench ‚Ä¢ Variants</div></div>
              <div class="row"><div>Profile</div><div>Default</div></div>
            </div>
          </div>
        </div>
        <!-- Button area (two rows) -->
        <div class="btn-area">
          <div class="row-top">
            <div class="btnbar" id="domainBar" role="tablist" aria-label="Domains">
              <button class="btn9 small" data-domain="wargames">Tabletop</button>
              <button class="btn9 small" data-domain="display">Display</button>
              <button class="btn9 small" data-domain="dnd">D&amp;D</button>
              <button class="btn9 small" data-domain="terrain">Terrain</button>
              <button class="btn9 small" data-domain="scale">Scale Models</button>
              <button class="btn9 small" data-domain="unsorted">Other</button>
              <button class="btn9 small" data-domain="savedcollections">Favorites</button>             
            </div>
            <div class="frame ctrl-frame ctrl-search"><div class="content">
              <div class="searchbox"><input type="search" placeholder="Search..." aria-label="Search" /></div>
            </div></div>
            <div class="frame ctrl-frame ctrl-theme" role="button" tabindex="0"><div class="content">
              <button id="themeToggle" class="theme-toggle" type="button" aria-pressed="false" aria-label="Switch to light theme"></button>
            </div></div>
          </div>
          <div class="row-bottom">
            <div class="btnbar" id="systemBar" role="tablist" aria-label="Domain specifics">
              <!-- Default: Tabletop systems -->
              <button class="btn9 small" data-system="w40k" aria-pressed="true">40K</button>
              <button class="btn9 small" data-system="aos">AoS</button>
              <button class="btn9 small" data-system="heresy">Heresy</button>
              <button class="btn9 small" data-system="other">Other</button>
              <button class="btn9 small" data-system="agnostic">Agnostic</button>
            </div>
          </div>
          <div class="row-pins" id="pinsBar" aria-label="Pins">
            <!-- Reserved for pins; intentionally empty for now -->
          </div>
        </div>
      </div>
    </div>
    <!-- Banner dropdown menu container -->
  <div id="bannerMenu" class="banner-menu" aria-hidden="true" data-tail-gap="42" data-head-gap="0">
  <div class="menu-frame">
        <div class="menu-scroll">
          <div class="menu-items" role="menu" aria-label="Saved collections"></div>
        </div>
      </div>
    </div>

    <div class="app">
      <div class="appgrid">
        <!-- Workbench column -->
        <div class="workbench">
          <div class="frame">
            <div class="content">
              <div class="wb-toolbar">
                <div class="wb-left">
                  <div class="segmented" aria-label="View mode">
                    <button class="btn active" id="btnGrid">Grid</button>
                    <button class="btn" id="btnList">List</button>
                  </div>
                  <button class="icon-btn" id="btnSidecar">Sidecar Files</button>
                  <span class="badge">Sort: Updated</span>
                </div>
                <div class="wb-right">
                  <button class="icon-btn" id="btnRefresh">Refresh</button>
                </div>
              </div>

              <div class="workbench-inner" id="wbInner">
                <div>
                  <!-- Results container -->
                  <div class="cards" id="cards">
                    <div class="frame card"><div class="content">Variant Card A<br/><span class="muted">badges‚Ä¶</span></div></div>
                    <div class="frame card"><div class="content">Variant Card B</div></div>
                    <div class="frame card"><div class="content">Variant Card C</div></div>
                    <div class="frame card"><div class="content">Variant Card D</div></div>
                  </div>
                  <div class="rowlist" id="rows" style="display:none">
                    <div class="table-row"><div>Variant Row A</div><div><span class="badge">32mm</span></div></div>
                    <div class="table-row"><div>Variant Row B</div><div><span class="badge">Hero</span></div></div>
                    <div class="table-row"><div>Variant Row C</div><div><span class="badge">Weapon</span></div></div>
                  </div>
                </div>
                <div class="sidecar">
                  <div class="frame"><div class="content">
                    <h3>Files</h3>
                    <div class="spacer"></div>
                    <div class="kv"><div>helm.stl</div><div class="muted">1.2 MB ‚Ä¢ model/stl</div></div>
                    <div class="kv"><div>torso.stl</div><div class="muted">2.8 MB ‚Ä¢ model/stl</div></div>
                    <div class="kv"><div>readme.png</div><div class="muted">45 KB ‚Ä¢ image/png</div></div>
                  </div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Inspector column -->
        <div class="inspector">
          <div class="frame"><div class="content">
            <div class="insp-layout">
              <!-- 1) Wide box: Variant name -->
              <div class="ibox name" id="inspName"><div class="label">Variant name</div></div>

              <!-- 2) Middle: side squares + tall preview -->
              <div class="midgrid">
                <div class="sidecol">
                  <div class="ibox sq"><div class="label">NSFW</div></div>
                  <div class="ibox sq"><div class="label">Scale or Base</div></div>
                <div class="ibox rect fav"><div class="label">Favorite</div><div class="fav-indicator" title="Target: Favorites"><span class="txt">‚òÖ</span></div></div>
                </div>
                <div class="preview">
                  <div class="ibox tall" id="inspPreview"><div class="label">Preview</div></div>
                </div>
                <div class="sidecol">
                  <div class="ibox sq"><div class="label">Support</div></div>
                  <div class="ibox sq"><div class="label">Segmentation</div></div>
                  <div class="ibox rect"><div class="label">Report mismatch</div></div>
                </div>
              </div>

              <!-- 3) Six wide boxes for metadata -->
              <div class="insp-meta-grid">
                <div class="ibox meta"><div class="label">Game system</div></div>
                <div class="ibox meta"><div class="label">Faction T1</div></div>
                <div class="ibox meta"><div class="label">Faction T2</div></div>
                <div class="ibox meta"><div class="label">Codex Unit</div></div>
                <div class="ibox meta"><div class="label">Designer</div></div>
                <div class="ibox meta"><div class="label">Collection</div></div>
              </div>

              <!-- 4) Big files box -->
              <div class="ibox files grid-bg" id="inspFiles"><div class="label">Files</div></div>
            </div>
          </div>
          <div class="insp-foot">
            <div class="frame notes-box"><div class="content">
              <div class="title">Notes</div>
              <div class="notes-grid">
                <textarea class="textarea" placeholder="Add a note about this model‚Ä¶" disabled></textarea>
                <div class="checklist">
                  <label><input type="checkbox" disabled/> Printed</label>
                  <label><input type="checkbox" disabled/> Prepped</label>
                  <label><input type="checkbox" disabled/> Primed</label>
                  <label><input type="checkbox" disabled/> Painted</label>
                </div>
              </div>
              <div class="license-inline" aria-label="License info (demo)">
                <div>Link</div><div><a href="#" tabindex="-1">Store page</a></div>
              </div>
            </div></div>
          </div></div>
        </div>
      </div>
    </div>

    <!-- Debug Grid Overlay (dev-only) -->
    <div id="gridOverlay" aria-hidden="true"></div>
    <div id="gridCtrl" class="frame" aria-label="Grid controls">
      <div class="content">
  <div class="row"><div>Unit (px)</div><input id="gUnit" type="range" min="2" max="16" step="1" value="4"/><input id="gUnitN" type="number" min="2" max="16" step="1" value="4"/></div>
  <div class="row"><div>Major every</div><input id="gMajor" type="range" min="2" max="32" step="1" value="5"/><input id="gMajorN" type="number" min="2" max="32" step="1" value="5"/></div>
  <div class="row"><div>Minor opacity</div><input id="gMinorOpacity" type="range" min="0" max="1" step="0.01" value="0.06"/><input id="gMinorOpacityN" type="number" min="0" max="1" step="0.01" value="0.06"/></div>
  <div class="row"><div>Major opacity</div><input id="gMajorOpacity" type="range" min="0" max="1" step="0.01" value="0.12"/><input id="gMajorOpacityN" type="number" min="0" max="1" step="0.01" value="0.12"/></div>
        <div class="row"><label><input id="gCols" type="checkbox" checked/> Columns</label><label><input id="gRows" type="checkbox" checked/> Rows</label></div>
        <div class="row"><div>Origin X</div><input id="gOX" type="number" value="0"/></div>
        <div class="row"><div>Origin Y</div><input id="gOY" type="number" value="0"/></div>
        <div class="actions">
          <button id="gReset" class="btn">Reset</button>
          <button id="gHide" class="btn">Hide</button>
        </div>
      </div>
    </div>

    <!-- Backdrop wrapper and drawer attached tabs (same structure as front_page_mock) -->
    <div id="drawerWrap" class="drawer-wrap" aria-hidden="true">
      <div id="drawerBackdrop" class="drawer-backdrop" tabindex="-1" aria-hidden="true"></div>
    </div>
    <div id="drawer" class="frame drawer" role="dialog" aria-modal="false" aria-labelledby="drawerTitle">
      <div class="header">
        <div class="title" id="drawerTitle">Filters</div>
        <button class="pin" id="drawerPin" aria-pressed="false" aria-label="Pin drawer">üìå</button>
        <button class="close" id="drawerClose" aria-label="Close">‚úï</button>
      </div>
      <div class="body">
        <!-- Lineage tab -->
        <section id="panel-lineage" class="tabpanel active" role="region" aria-labelledby="tab-lineage">
          <div class="hint">Choose one or more lineages to focus results.</div>
          <div class="searchbox small" style="margin-bottom:6px;"><input id="lineageFilter" type="search" placeholder="Filter lineages‚Ä¶" aria-label="Filter lineages"/></div>
          <div class="filters-col scroll" id="lineageList">
            <label><input type="checkbox" value="Undead"/> Undead</label>
            <label><input type="checkbox" value="Demons"/> Demons</label>
            <label><input type="checkbox" value="Orcs / Greenskins"/> Orcs / Greenskins</label>
            <label><input type="checkbox" value="Elves / Aeldari"/> Elves / Aeldari</label>
            <label><input type="checkbox" value="Soldiers / Humans"/> Soldiers / Humans</label>
            <label><input type="checkbox" value="Dwarves / Duardin"/> Dwarves / Duardin</label>
            <label><input type="checkbox" value="Chaos"/> Chaos</label>
            <label><input type="checkbox" value="Beasts"/> Beasts</label>
            <label><input type="checkbox" value="Monsters"/> Monsters</label>
          </div>
        </section>
        <!-- Base tab -->
        <section id="panel-base" class="tabpanel" role="region" aria-labelledby="tab-base">
          <div class="hint">Base profile options moved to ‚ÄúMore‚Äù.</div>
        </section>
        <!-- NSFW tab -->
        <section id="panel-nsfw" class="tabpanel" role="region" aria-labelledby="tab-nsfw">
          <div class="hint">Control sensitive content visibility.</div>
          <div class="filters-col">
            <label><input type="radio" name="nsfw" value="hide"/> Hide NSFW entirely</label>
            <label><input type="radio" name="nsfw" value="blur"/> Blur thumbnails</label>
            <label><input type="radio" name="nsfw" value="show"/> Show with badge</label>
          </div>
        </section>
        <!-- More tab -->
        <section id="panel-more" class="tabpanel" role="region" aria-labelledby="tab-more">
          <div class="hint">Additional quick filters.</div>
          <div class="filters-col">
            <label><input type="checkbox"/> Supported</label>
            <label><input type="checkbox"/> Segmentation available</label>
            <label><input type="checkbox"/> Multi‚Äëpart</label>
            <label><input type="checkbox"/> Has alternate heads</label>
            <label><input type="checkbox"/> Includes bases</label>
          </div>
          <div class="spacer"></div>
          <div class="hint">Base profile options</div>
          <div class="filters-col">
            <label><input type="checkbox"/> 25mm Round</label>
            <label><input type="checkbox"/> 28mm Round</label>
            <label><input type="checkbox"/> 32mm Round</label>
            <label><input type="checkbox"/> 40mm Round</label>
            <label><input type="checkbox"/> 50mm Round</label>
            <label><input type="checkbox"/> 60mm Round</label>
            <label><input type="checkbox"/> 90mm Round</label>
            <label><input type="checkbox"/> 120mm Oval</label>
            <label><input type="checkbox"/> 60x35mm Oval</label>
            <label><input type="checkbox"/> 75x42mm Oval</label>
            <label><input type="checkbox"/> 25mm Square</label>
            <label><input type="checkbox"/> 40mm Square</label>
          </div>
        </section>
        <!-- Saved / Personal tab -->
        <section id="panel-saved" class="tabpanel" role="region" aria-labelledby="tab-saved">
          <div class="hint">Filter your saved items, workflow states, and personal notes.</div>
          <div class="filters-col">
            <label><input type="checkbox"/> In Favorites</label>
            <label><input type="checkbox"/> In any collection</label>
          </div>
          <div class="spacer"></div>
          <div class="hint">Collections</div>
          <div class="collection-box" role="listbox" aria-label="Collections" aria-multiselectable="true">
            <div class="collection-list" id="savedCollections">
              <div class="collection-item" role="option" data-id="c1" aria-selected="false"><span class="name">Favorites</span><span class="meta">‚òÖ</span></div>
              <div class="collection-item" role="option" data-id="c2" aria-selected="false"><span class="name">Skulls & Bones</span><span class="meta">12</span></div>
              <div class="collection-item" role="option" data-id="c3" aria-selected="false"><span class="name">Heresy - Sons of Horus</span><span class="meta">8</span></div>
              <div class="collection-item" role="option" data-id="c4" aria-selected="false"><span class="name">AoS - Stormcast</span><span class="meta">5</span></div>
              <div class="collection-item" role="option" data-id="c5" aria-selected="false"><span class="name">W40K - Orks</span><span class="meta">14</span></div>
              <div class="collection-item" role="option" data-id="c6" aria-selected="false"><span class="name">Display - Busts</span><span class="meta">9</span></div>
              <div class="collection-item" role="option" data-id="c7" aria-selected="false"><span class="name">D&amp;D - Monsters</span><span class="meta">21</span></div>
              <div class="collection-item" role="option" data-id="c8" aria-selected="false"><span class="name">Terrain - Ruins</span><span class="meta">6</span></div>
              <div class="collection-item" role="option" data-id="c9" aria-selected="false"><span class="name">Scale - Tanks</span><span class="meta">11</span></div>
              <div class="collection-item" role="option" data-id="c10" aria-selected="false"><span class="name">Heresy - Ultramarines</span><span class="meta">7</span></div>
              <div class="collection-item" role="option" data-id="c11" aria-selected="false"><span class="name">AoS - Nighthaunt</span><span class="meta">13</span></div>
              <div class="collection-item" role="option" data-id="c12" aria-selected="false"><span class="name">Kitbashes</span><span class="meta">4</span></div>
              <div class="collection-item" role="option" data-id="c13" aria-selected="false"><span class="name">To Print Soon</span><span class="meta">10</span></div>
              <div class="collection-item" role="option" data-id="c14" aria-selected="false"><span class="name">Paint Queue</span><span class="meta">16</span></div>
              <div class="collection-item" role="option" data-id="c15" aria-selected="false"><span class="name">Archived</span><span class="meta">32</span></div>
            </div>
          </div>
          <div class="spacer"></div>
          <div class="hint">Workflow status</div>
          <div class="filters-col">
            <label><input type="checkbox"/> Printed</label>
            <label><input type="checkbox"/> Prepped</label>
            <label><input type="checkbox"/> Primed</label>
            <label><input type="checkbox"/> Painted</label>
            <label><input type="checkbox"/> Has personal notes</label>
          </div>
          <div class="spacer"></div>
          <div class="hint">Search notes</div>
          <div class="searchbox small"><input type="search" placeholder="Search notes‚Ä¶" aria-label="Search notes"/></div>
        </section>
      </div>
      <div class="footer">
        <button class="btn" id="drawerClear">Clear</button>
        <button class="btn" id="drawerApply">Apply</button>
      </div>
      <div class="drawer-resize" id="drawerResize" aria-hidden="true"></div>
    </div>
    <div class="drawer-tabs" role="toolbar" aria-label="Quick filters">
      <button class="drawer-tab" id="tab-lineage" data-tab="lineage" aria-pressed="false" title="Lineage"><span class="txt">Lineage</span><span class="count"></span></button>
      <button class="drawer-tab" id="tab-base" data-tab="base" aria-pressed="false" title="Base options"><span class="txt">Base</span><span class="count"></span></button>
      <button class="drawer-tab" id="tab-nsfw" data-tab="nsfw" aria-pressed="false" title="NSFW"><span class="txt">NSFW</span><span class="count"></span></button>
      <button class="drawer-tab" id="tab-more" data-tab="more" aria-pressed="false" title="More filters"><span class="txt">More</span><span class="count"></span></button>
      <button class="drawer-tab" id="tab-saved" data-tab="saved" aria-pressed="false" title="Saved & notes"><span class="txt">Saved</span><span class="count"></span></button>
    </div>
    <div class="drawer-tabs-hit" aria-hidden="false">
      <button class="drawer-tab" data-ref="#tab-lineage" data-tab="lineage" aria-pressed="false" title="Lineage"><span class="txt">Lineage</span><span class="count"></span></button>
      <button class="drawer-tab" data-ref="#tab-base" data-tab="base" aria-pressed="false" title="Base options"><span class="txt">Base</span><span class="count"></span></button>
      <button class="drawer-tab" data-ref="#tab-nsfw" data-tab="nsfw" aria-pressed="false" title="NSFW"><span class="txt">NSFW</span><span class="count"></span></button>
      <button class="drawer-tab" data-ref="#tab-more" data-tab="more" aria-pressed="false" title="More filters"><span class="txt">More</span><span class="count"></span></button>
      <button class="drawer-tab" data-ref="#tab-saved" data-tab="saved" aria-pressed="false" title="Saved & notes"><span class="txt">Saved</span><span class="count"></span></button>
    </div>

    <!-- Ambient info panel: background-like, non-interactive area under the drawer space -->
    <aside class="ambient-info" aria-hidden="true">
      <div class="ambient-card">
        <div class="title">Workspace</div>
        <div class="ambient-rows">
          <div class="row"><div>DB</div><div>stl_manager_v1.db</div></div>
          <div class="row"><div>View</div><div>Workbench ‚Ä¢ Variants</div></div>
          <div class="row"><div>Profile</div><div>Default</div></div>
        </div>
        <div class="ambient-foot">Tip: press G to toggle the 4px grid overlay.</div>
      </div>
    </aside>

    <script>
      // Saved panel: basic selection toggling for collection list (visual only)
      (function(){
        const list = document.getElementById('savedCollections');
        if (!list) return;
        list.addEventListener('click', (e) => {
          const item = e.target.closest('.collection-item');
          if (!item) return;
          const sel = item.getAttribute('aria-selected') === 'true';
          const next = !sel;
          item.setAttribute('aria-selected', String(next));
          item.classList.toggle('selected', next);
        });
      })();
    </script>
    <script>
      const btnSidecar = document.getElementById('btnSidecar');
      const wbInnerEl = document.getElementById('wbInner');
      const workbenchEl = wbInnerEl ? wbInnerEl.closest('.workbench') : null;
      if (btnSidecar && workbenchEl) {
        btnSidecar.addEventListener('click', () => {
          workbenchEl.classList.toggle('with-sidecar');
        });
      }

      const btnGrid = document.getElementById('btnGrid');
      const btnList = document.getElementById('btnList');
      const cards = document.getElementById('cards');
      const rows = document.getElementById('rows');
      btnGrid.addEventListener('click', () => { btnGrid.classList.add('active'); btnList.classList.remove('active'); cards.style.display='grid'; rows.style.display='none'; });
      btnList.addEventListener('click', () => { btnList.classList.add('active'); btnGrid.classList.remove('active'); cards.style.display='none'; rows.style.display='grid'; });

      // Debug Grid Overlay (toggle with 'G'; Shift+G cycles unit)
      (function(){
        const D = document.documentElement;
        const B = document.body;
        const elCtrl = document.getElementById('gridCtrl');
        const unit = document.getElementById('gUnit');
  const major = document.getElementById('gMajor');
  const mOp = document.getElementById('gMinorOpacity');
  const MOp = document.getElementById('gMajorOpacity');
  const unitN = document.getElementById('gUnitN');
  const majorN = document.getElementById('gMajorN');
  const mOpN = document.getElementById('gMinorOpacityN');
  const MOpN = document.getElementById('gMajorOpacityN');
        const showCols = document.getElementById('gCols');
        const showRows = document.getElementById('gRows');
        const oX = document.getElementById('gOX');
        const oY = document.getElementById('gOY');
        const btnHide = document.getElementById('gHide');
        const btnReset = document.getElementById('gReset');

        function setVar(name, val){ D.style.setProperty(name, val); }
        function updateColors(){
          const minor = `rgba(255,255,255,${parseFloat(mOp.value).toFixed(2)})`;
          const majorC = `rgba(255,255,255,${parseFloat(MOp.value).toFixed(2)})`;
          setVar('--grid-minor-color', (showCols.checked || showRows.checked) ? minor : 'transparent');
          setVar('--grid-major-color', (showCols.checked || showRows.checked) ? majorC : 'transparent');
        }
        function applyAll(){
          setVar('--grid-u', unit.value + 'px');
          setVar('--grid-major', major.value);
          setVar('--grid-origin-x', (parseInt(oX.value)||0) + 'px');
          setVar('--grid-origin-y', (parseInt(oY.value)||0) + 'px');
          updateColors();
          const ov = document.getElementById('gridOverlay');
          ov.style.backgroundImage = [
            showRows.checked ? 'linear-gradient(to bottom, transparent calc(var(--grid-u) - 1px), var(--grid-minor-color) 1px)' : 'none',
            showCols.checked ? 'linear-gradient(to right,  transparent calc(var(--grid-u) - 1px), var(--grid-minor-color) 1px)' : 'none',
            showRows.checked ? 'linear-gradient(to bottom, transparent calc((var(--grid-u) * var(--grid-major)) - 1px), var(--grid-major-color) 1px)' : 'none',
            showCols.checked ? 'linear-gradient(to right,  transparent calc((var(--grid-u) * var(--grid-major)) - 1px), var(--grid-major-color) 1px)' : 'none'
          ].filter(s => s !== 'none').join(',');
          const sizes = [
            showRows.checked ? 'var(--grid-u) var(--grid-u)' : null,
            showCols.checked ? 'var(--grid-u) var(--grid-u)' : null,
            showRows.checked ? 'calc(var(--grid-u) * var(--grid-major)) calc(var(--grid-u) * var(--grid-major))' : null,
            showCols.checked ? 'calc(var(--grid-u) * var(--grid-major)) calc(var(--grid-u) * var(--grid-major))' : null,
          ].filter(Boolean).join(',');
          ov.style.backgroundSize = sizes;
        }
        function toggle(){ B.classList.toggle('debug-grid-on'); applyAll(); }
        function show(){ if(!B.classList.contains('debug-grid-on')) B.classList.add('debug-grid-on'); applyAll(); }
        function hide(){ B.classList.remove('debug-grid-on'); }
        function reset(){ unit.value=4; major.value=5; mOp.value=0.06; MOp.value=0.12; showCols.checked=true; showRows.checked=true; oX.value=0; oY.value=0; applyAll(); }

        function syncPair(rangeEl, numEl, parser) {
          const parse = parser || ((v)=>v);
          rangeEl.addEventListener('input', () => { numEl.value = String(rangeEl.value); applyAll(); });
          numEl.addEventListener('input', () => { rangeEl.value = String(parse(numEl.value)); applyAll(); });
        }
        syncPair(unit, unitN, v=>Math.max(2, Math.min(16, Math.round(parseFloat(v)||4))));
        syncPair(major, majorN, v=>Math.max(2, Math.min(32, Math.round(parseFloat(v)||5))));
  syncPair(mOp, mOpN, v=>Math.max(0, Math.min(1, parseFloat(v)||0)));
  syncPair(MOp, MOpN, v=>Math.max(0, Math.min(1, parseFloat(v)||0)));
        showCols.addEventListener('change', applyAll);
        showRows.addEventListener('change', applyAll);
        oX.addEventListener('input', applyAll);
        oY.addEventListener('input', applyAll);
        btnHide.addEventListener('click', hide);
        btnReset.addEventListener('click', () => { show(); reset(); unitN.value=unit.value; majorN.value=major.value; mOpN.value=mOp.value; MOpN.value=MOp.value; applyAll(); });

        document.addEventListener('keydown', (e) => {
          if (e.key.toLowerCase() === 'g' && !e.altKey && !e.ctrlKey && !e.metaKey) {
            if (e.shiftKey) {
              // Cycle common units
              const opts = [4, 6, 8, 10, 12];
              const cur = parseInt(unit.value) || 4;
              const idx = opts.indexOf(cur);
              unit.value = String(opts[(idx + 1) % opts.length]);
              show();
              applyAll();
            } else {
              toggle();
            }
            e.preventDefault();
          }
          if (e.key.toLowerCase() === 'g' && (e.ctrlKey || e.altKey)) {
            // Toggle panel visibility and ensure overlay is visible for immediate feedback
            elCtrl.style.display = (elCtrl.style.display === 'none' || !elCtrl.style.display) ? 'block' : 'none';
            show();
            e.preventDefault();
          }
        });

        // Initialize hidden; user toggles with 'g'
        applyAll();
      })();

      // Theme toggle (framed control)
      (function(){
        const root = document.documentElement;
        const toggle = document.getElementById('themeToggle');
        const frame = document.querySelector('.ctrl-frame.ctrl-theme');
        if (!toggle || !frame) return;
        function applyTheme(next) {
          if (next === 'light') {
            root.setAttribute('data-theme', 'light');
            toggle.setAttribute('aria-pressed','true');
            toggle.setAttribute('aria-label','Switch to dark theme');
          } else {
            root.setAttribute('data-theme', 'dark');
            toggle.setAttribute('aria-pressed','false');
            toggle.setAttribute('aria-label','Switch to light theme');
          }
        }
        applyTheme('dark');
        function onToggle(){ const isLight = root.getAttribute('data-theme')==='light'; applyTheme(isLight?'dark':'light'); }
        toggle.addEventListener('click', (e) => { e.stopPropagation(); onToggle(); });
        frame.addEventListener('click', onToggle);
        frame.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); onToggle(); }
        });
      })();

      // Domain + system bars: simple pressed-state toggle and swapping row-bottom buttons
      (function(){
        const domainBar = document.getElementById('domainBar');
        const systemBar = document.getElementById('systemBar');
        const bannerMenu = document.getElementById('bannerMenu');
        const bannerItems = bannerMenu ? bannerMenu.querySelector('.menu-items') : null;
        let bannerClickAttached = false;
        function onBannerItemClick(e){
          const it = e.target.closest('.menu-item');
          if (!it) return;
          const val = it.getAttribute('data-value');
          const label = it.textContent;
          systemBar.innerHTML = `<button class="btn9 small" data-system="${val}" aria-pressed="true">${label}</button>`;
          closeBanner();
          try { systemBar.dispatchEvent(new CustomEvent('systemsUpdated', { bubbles: true })); } catch (e) {}
        }
        const SYSTEMS = {
          wargames: [ ['w40k','40K'], ['aos','AoS'], ['heresy','Heresy'], ['trenchcrusade','Trench Crusade'], ['historical','Historical'], ['other','Other'], ['agnostic','Agnostic'] ],
          display: [ ['studio','Studio'], ['fantasy','Fantasy'], ['sci-fi','Sci‚ÄëFi'], ['nsfw','NSFW'] ],
          dnd: [ ['characters','Characters'], ['monsters','Monsters'], ['animals','Animals'], ['props','Props'] ],
          terrain: [ ['battlefield','Battlefield'], ['scenery','Scenery'], ['buildings','Buildings'] ],
          scale: [ ['cars','Cars'], ['tanks','Tanks'], ['animals','Animals'], ['1-35','1:35'], ['1-48','1:48'], ['1-56','1:56'] ],
          unsorted: [ ['other','Other'], ['agnostic','Agnostic'] ],
          savedcollections: [
            ['favorites','Favorites'],
            ['skulls-bones','Skulls & Bones'],
            ['heresy-soh','Heresy - Sons of Horus'],
            ['aos-stormcast','AoS - Stormcast'],
            ['w40k-orks','W40K - Orks'],
            ['display-busts','Display - Busts'],
            ['dnd-monsters','D&D - Monsters'],
            ['terrain-ruins','Terrain - Ruins'],
            ['scale-tanks','Scale - Tanks'],
            ['heresy-ultra','Heresy - Ultramarines'],
            ['aos-nighthaunt','AoS - Nighthaunt'],
            ['kitbashes','Kitbashes'],
            ['to-print-soon','To Print Soon'],
            ['paint-queue','Paint Queue'],
            ['archived','Archived']
          ],
        };
        function setPressed(bar, btn){ Array.from(bar.querySelectorAll('.btn9')).forEach(b=>b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true'); }
        function renderSystems(key){
          const items = SYSTEMS[key] || [];
          // Use banner dropdown for all domains (row 1 buttons)
          const useBanner = true;
          if (useBanner && bannerMenu && bannerItems && items.length) {
            systemBar.innerHTML = '';
            bannerItems.setAttribute('aria-label', key.replace(/(^.|_.?)/g, s=>s.toUpperCase()).replace(/_/g,' '));
            bannerItems.innerHTML = items.map(([v,l])=>`<button class="menu-item" role="menuitem" data-value="${v}">${l}</button>`).join('');
            const activeDomain = domainBar.querySelector('.btn9[aria-pressed="true"]') || domainBar.querySelector(`.btn9[data-domain="${key}"]`);
            if (activeDomain) {
              const r = activeDomain.getBoundingClientRect();
              bannerMenu.style.left = Math.round(r.left) + 'px';
              bannerMenu.style.top = Math.round(r.bottom) + 'px';
              bannerMenu.style.width = Math.round(r.width) + 'px';
            }
            // Apply configurable gaps; allow active domain button to override
            const activeBtn = domainBar.querySelector('.btn9[aria-pressed="true"]');
            const btnTail = activeBtn ? activeBtn.getAttribute('data-tail-gap') : null;
            const btnHead = activeBtn ? activeBtn.getAttribute('data-head-gap') : null;
            const gap = parseInt((btnTail ?? bannerMenu.getAttribute('data-tail-gap') ?? '16'), 10);
            const frame = bannerMenu.querySelector('.menu-frame');
            if (frame) frame.style.setProperty('--banner-tail-gap', (isFinite(gap)?gap:16) + 'px');
            const headGap = parseInt((btnHead ?? bannerMenu.getAttribute('data-head-gap') ?? '24'), 10);
            if (frame) frame.style.setProperty('--banner-head-gap', (isFinite(headGap)?headGap:24) + 'px');
            // Open first so layout is accurate
            bannerMenu.classList.add('open');
            bannerMenu.setAttribute('aria-hidden','false');
            // Measure and size on next frame when layout is settled
            requestAnimationFrame(() => {
              try {
                const itemsEls = bannerItems.querySelectorAll('.menu-item');
                const scroller = bannerMenu.querySelector('.menu-scroll');
                if (frame && scroller && itemsEls.length) {
                  const scrollStyle = getComputedStyle(scroller);
                  const padTop = parseFloat(scrollStyle.paddingTop) || 0;
                  const padBottom = parseFloat(scrollStyle.paddingBottom) || 0;
                  const rowGap = parseFloat(getComputedStyle(bannerItems).rowGap) || 0;
                  const itemRect = itemsEls[0].getBoundingClientRect();
                  const itemH = itemRect.height || 0;
                  const shouldScroll = itemsEls.length >= 8;
                  const n = shouldScroll ? 7 : itemsEls.length; // show up to 7 items before scroll
                  const itemsBlock = (itemH * n) + (rowGap * Math.max(0, n - 1));
                  const desired = padTop + itemsBlock + padBottom;
                  // Constrain to viewport below the button using actual position
                  const menuTop = bannerMenu.getBoundingClientRect().top;
                  const avail = Math.max(120, (window.innerHeight - menuTop - 8));
                  const finalH = Math.max(120, Math.min(desired, avail));
                  frame.style.maxHeight = finalH + 'px';
                  frame.style.height = finalH + 'px';
                  if (shouldScroll) {
                    const tailGapPx = Math.max(0, parseInt(getComputedStyle(frame).getPropertyValue('--banner-tail-gap')) || 0);
                    const scrollH = Math.max(80, finalH - tailGapPx);
                    scroller.style.height = scrollH + 'px';
                    scroller.style.maxHeight = scrollH + 'px';
                    scroller.style.overflowY = 'auto';
                  } else {
                    scroller.style.height = '';
                    scroller.style.maxHeight = '';
                    scroller.style.overflowY = 'hidden';
                  }
                }
              } catch (e) { /* no-op */ }
            });
            if (!bannerClickAttached) { bannerItems.addEventListener('click', onBannerItemClick); bannerClickAttached = true; }
            return;
          }
          // Inline buttons for other domains
          systemBar.innerHTML = items.map(([v,l],i)=>`<button class="btn9 small" data-system="${v}" aria-pressed="${i===0?'true':'false'}">${l}</button>`).join('');
          try { systemBar.dispatchEvent(new CustomEvent('systemsUpdated', { bubbles: true })); } catch (e) {}
          closeBanner();
        }
        function closeBanner(){
          if (!bannerMenu) return;
          bannerMenu.classList.remove('open');
          bannerMenu.setAttribute('aria-hidden','true');
          if (bannerClickAttached && bannerItems) { bannerItems.removeEventListener('click', onBannerItemClick); bannerClickAttached = false; }
          const frame = bannerMenu.querySelector('.menu-frame');
          if (frame) { frame.style.maxHeight = ''; frame.style.height = ''; }
          const scroller = bannerMenu.querySelector('.menu-scroll');
          if (scroller) { scroller.style.maxHeight = ''; scroller.style.height = ''; }
        }
        // Close on outside click or Escape
        document.addEventListener('click', (e)=>{
          if (!bannerMenu || !bannerMenu.classList.contains('open')) return;
          const withinMenu = e.target.closest('#bannerMenu');
          const onDomain = e.target.closest('#domainBar .btn9');
          if (!withinMenu && !onDomain) closeBanner();
        });
        document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeBanner(); });
        // Restore last domain selection
        try {
          const lastDomain = localStorage.getItem('stlmgr_last_domain');
          const btn = lastDomain ? domainBar.querySelector(`.btn9[data-domain="${lastDomain}"]`) : domainBar.querySelector(`.btn9[data-domain="wargames"]`);
          if (btn) {
            setPressed(domainBar, btn);
            // Don't open banner on initial load; defer rendering until user interacts
            systemBar.innerHTML = '';
            if (bannerMenu) { bannerMenu.classList.remove('open'); bannerMenu.setAttribute('aria-hidden','true'); }
          }
        } catch (e) {}

        domainBar.addEventListener('click', (e)=>{
          const btn = e.target.closest('.btn9[data-domain]'); if(!btn) return;
          setPressed(domainBar, btn);
          renderSystems(btn.dataset.domain);
          try { localStorage.setItem('stlmgr_last_domain', btn.dataset.domain); } catch (e) {}
        });
      })();

      // Drawer wiring (copied from front_page_mock)
      (function() {
        const wrap = document.getElementById('drawerWrap');
        const drawer = document.getElementById('drawer');
        const backdrop = document.getElementById('drawerBackdrop');
        const closeBtn = document.getElementById('drawerClose');
        const pinBtn = document.getElementById('drawerPin');
        const applyBtn = document.getElementById('drawerApply');
        const clearBtn = document.getElementById('drawerClear');
        const resizeHandle = document.getElementById('drawerResize');
        const visualTabsRoot = document.querySelector('.drawer-tabs');
        const hitTabsRoot = document.querySelector('.drawer-tabs-hit');
        const tabs = Array.from(visualTabsRoot.querySelectorAll('.drawer-tab'));
        const tabsHit = Array.from(hitTabsRoot.querySelectorAll('.drawer-tab'));
        const panels = {
          lineage: document.getElementById('panel-lineage'),
          base: document.getElementById('panel-base'),
          nsfw: document.getElementById('panel-nsfw'),
          more: document.getElementById('panel-more'),
          saved: document.getElementById('panel-saved'),
        };
        const saveKey = 'stlmgr_dock_active';
        const pinKey = 'stlmgr_dock_pinned';
        const wKey = 'stlmgr_drawer_w';

        function syncDrawerTop() {
          const app = document.querySelector('.app');
          if (!app) return;
          const top = Math.max(0, Math.round(app.getBoundingClientRect().top + window.scrollY));
          document.documentElement.style.setProperty('--drawer-top', top + 'px');
        }
        window.addEventListener('resize', syncDrawerTop);
        window.addEventListener('load', syncDrawerTop);
        syncDrawerTop();

        function openDrawer(which) {
          Object.values(panels).forEach(p => p.classList.remove('active'));
          if (panels[which]) panels[which].classList.add('active');
          const isActive = (t) => t.dataset.tab === which;
          tabs.forEach(t => t.setAttribute('aria-pressed', String(isActive(t))));
          tabsHit.forEach(t => t.setAttribute('aria-pressed', String(isActive(t))));
          drawer.querySelector('#drawerTitle').textContent = (which || 'Filters').toUpperCase();
          wrap.classList.add('open');
          drawer.classList.add('open');
          wrap.setAttribute('aria-hidden', 'false');
          try { localStorage.setItem(saveKey, which); } catch (e) {}
        }
        function closeDrawer() {
          if (pinBtn.getAttribute('aria-pressed') === 'true') return;
          wrap.classList.remove('open');
          drawer.classList.remove('open');
          wrap.setAttribute('aria-hidden', 'true');
          tabs.forEach(t => t.setAttribute('aria-pressed', 'false'));
          tabsHit.forEach(t => t.setAttribute('aria-pressed', 'false'));
        }
        function onTabClick(which) { openDrawer(which); }
        tabs.forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); onTabClick(btn.dataset.tab); }); });
        tabsHit.forEach(btn => {
          btn.addEventListener('click', (e) => { e.stopPropagation(); onTabClick(btn.dataset.tab); });
          const refSel = btn.getAttribute('data-ref');
          const visualBtn = refSel ? document.querySelector(refSel) : null;
          btn.addEventListener('mouseenter', () => { visualBtn?.classList.add('is-hover'); });
          btn.addEventListener('mouseleave', () => { visualBtn?.classList.remove('is-hover'); });
        });
        backdrop.addEventListener('click', closeDrawer);
        closeBtn.addEventListener('click', closeDrawer);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDrawer(); });

        try {
          const last = localStorage.getItem(saveKey);
          if (last && panels[last]) { tabs.find(t => t.dataset.tab === last)?.setAttribute('aria-pressed', 'true'); }
          const pinned = localStorage.getItem(pinKey) === 'true';
          if (pinned) pinBtn.setAttribute('aria-pressed', 'true');
        } catch (e) {}

        pinBtn.addEventListener('click', () => {
          const next = pinBtn.getAttribute('aria-pressed') !== 'true';
          pinBtn.setAttribute('aria-pressed', String(next));
          try { localStorage.setItem(pinKey, String(next)); } catch (e) {}
        });

        // Resize
        let resizing = false, startX = 0, startW = 0;
        function onMove(e) {
          if (!resizing) return;
          const dx = (e.clientX || (e.touches && (e.touches[0]?.clientX)) || 0) - startX;
          const w = Math.max(280, Math.min(640, startW + dx));
          document.documentElement.style.setProperty('--drawer-w', w + 'px');
        }
        function onUp() {
          if (!resizing) return;
          resizing = false;
          try { localStorage.setItem(wKey, getComputedStyle(document.documentElement).getPropertyValue('--drawer-w').trim()); } catch (e) {}
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
        }
        resizeHandle.addEventListener('mousedown', (e) => {
          resizing = true; startX = e.clientX; startW = drawer.getBoundingClientRect().width;
          window.addEventListener('mousemove', onMove);
          window.addEventListener('mouseup', onUp);
        });

        function updateCount(tab, count) {
          const updateFor = (btn) => {
            if (!btn) return;
            let badge = btn.querySelector('.count');
            if (!badge) { badge = document.createElement('span'); badge.className = 'count'; btn.appendChild(badge); }
            const txt = count > 9 ? '9+' : String(count);
            if (count > 0) { btn.classList.add('has-count'); badge.textContent = txt; }
            else { btn.classList.remove('has-count'); badge.textContent = ''; }
          };
          const vt = tabs.find(t => t.dataset.tab === tab);
          const ht = tabsHit.find(t => t.dataset.tab === tab);
          updateFor(vt); updateFor(ht);
        }
        applyBtn.addEventListener('click', () => {
          const current = tabs.find(t => t.getAttribute('aria-pressed') === 'true')?.dataset.tab;
          if (!current) return;
          const activeEl = panels[current];
          const count = activeEl ? activeEl.querySelectorAll('input[type="checkbox"]:checked, input[type="radio"]:checked').length : 0;
          updateCount(current, count);
        });
        clearBtn.addEventListener('click', () => {
          const current = tabs.find(t => t.getAttribute('aria-pressed') === 'true')?.dataset.tab;
          if (!current) return;
          const activeEl = panels[current];
          activeEl?.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(i => i.checked = false);
          updateCount(current, 0);
        });
      })();
      // No tuner or baked constants logic; values are fixed in :root
    </script>
    <script>
      // Live data wiring for list view and inspector
      (function(){
        const API_BASE = 'http://127.0.0.1:8000';
        const rowsEl = document.getElementById('rows');
        const cardsEl = document.getElementById('cards');
        const systemBar = document.getElementById('systemBar');
        const domainBar = document.getElementById('domainBar');
        const searchInput = document.querySelector('.ctrl-search input[type="search"]');
        const inspector = document.querySelector('.inspector .frame .content');

        function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

        function currentSystem(){
          const btn = systemBar.querySelector('.btn9[aria-pressed="true"]');
          return btn ? btn.getAttribute('data-system') : null;
        }

        async function fetchVariants(params){
          const u = new URL(API_BASE + '/variants');
          if (params.q) u.searchParams.set('q', params.q);
          if (params.system) u.searchParams.set('system', params.system);
          if (params.faction) u.searchParams.set('faction', params.faction);
          u.searchParams.set('limit', String(params.limit ?? 50));
          u.searchParams.set('offset', String(params.offset ?? 0));
          const res = await fetch(u.toString());
          if (!res.ok) throw new Error('API error ' + res.status);
          return res.json();
        }

        function fmtName(v){
          return v.ui_display_en || v.filename || v.rel_path || ('Variant #' + v.id);
        }

        function renderList(items){
          rowsEl.innerHTML = '';
          const frag = document.createDocumentFragment();
          items.forEach(v => {
            const row = document.createElement('div');
            row.className = 'table-row';
            row.setAttribute('data-id', String(v.id));
            const left = document.createElement('div');
            left.textContent = fmtName(v);
            const right = document.createElement('div');
            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.textContent = v.game_system ? v.game_system.toUpperCase() : (v.base_size_mm ? (v.base_size_mm + 'mm') : '#'+v.id);
            right.appendChild(badge);
            row.appendChild(left);
            row.appendChild(right);
            row.addEventListener('click', () => loadDetail(v.id));
            frag.appendChild(row);
          });
          rowsEl.appendChild(frag);
        }

        async function loadDetail(id){
          try{
            const res = await fetch(API_BASE + '/variants/' + id);
            if (!res.ok) throw new Error('Not found');
            const d = await res.json();
            const name = fmtName(d);
            inspector.innerHTML = `
              <h3>${name}</h3>
              <div class="spacer"></div>
              <div class="kv"><div>Designer</div><div>${d.designer || '‚Äî'}</div></div>
              <div class="kv"><div>System</div><div>${d.game_system || '‚Äî'}</div></div>
              <div class="kv"><div>Faction</div><div>${d.codex_faction || '‚Äî'}</div></div>
              <div class="kv"><div>Base</div><div>${d.base_size_mm ? d.base_size_mm + 'mm' : '‚Äî'}</div></div>
              <div class="spacer"></div>
              <div class="kv"><div>Path</div><div class="muted">${d.rel_path || '‚Äî'}</div></div>
            `;
          } catch(e){ /* no-op */ }
        }

        async function refresh(){
          const q = (searchInput && searchInput.value) ? searchInput.value.trim() : '';
          const system = currentSystem();
          try{
            const data = await fetchVariants({ q, system, limit: 50, offset: 0 });
            renderList(data.items || []);
            // If user is in list mode, keep rows visible; otherwise just prepare data
            if (rowsEl && rowsEl.style.display === 'none' && cardsEl) {
              // do not force switch; user controls the toggle
            }
          } catch(e){
            // Optionally render an error row
          }
        }

        const debouncedRefresh = debounce(refresh, 250);

        // Hook search
        if (searchInput) searchInput.addEventListener('input', debouncedRefresh);
        // Hook system changes: clicks on system bar
        systemBar.addEventListener('click', (e)=>{
          const btn = e.target.closest('.btn9[data-system]');
          if (!btn) return;
          // toggle pressed state among siblings
          Array.from(systemBar.querySelectorAll('.btn9')).forEach(b=>b.setAttribute('aria-pressed','false'));
          btn.setAttribute('aria-pressed','true');
          refresh();
        });
        // When systems list is regenerated due to domain change
        systemBar.addEventListener('systemsUpdated', ()=>{
          refresh();
        });

        // Initial load
        refresh();
      })();
    </script>
    <script>
      // Align inspector's left edge with the left edge of the search bar frame
      (function(){
        const root = document.documentElement;
        function computeInspectorLeft(){
          const el = document.querySelector('.ctrl-frame.ctrl-search');
          if (!el) return;
          const r = el.getBoundingClientRect();
          root.style.setProperty('--inspector-left', r.left + 'px');
        }
        window.addEventListener('load', computeInspectorLeft);
        window.addEventListener('resize', computeInspectorLeft);
        // Recompute on topbar interactions that can affect layout
        const topbar = document.querySelector('.topbar');
        if (topbar) {
          topbar.addEventListener('click', (e) => {
            if (e.target && e.target.closest('.btn9')) {
              // Defer to allow layout to settle
              requestAnimationFrame(computeInspectorLeft);
            }
          });
        }
        // Initial compute in case load has already fired
        requestAnimationFrame(computeInspectorLeft);
      })();
      // Align inspector's top edge with the top of the workbench frame
      ;(function(){
        const root = document.documentElement;
        function computeInspectorTop(){
          const wbFrame = document.querySelector('.workbench > .frame');
          if (!wbFrame) return;
          const r = wbFrame.getBoundingClientRect();
          // Use viewport-relative top so the fixed inspector matches as the user scrolls
          root.style.setProperty('--inspector-top', Math.max(0, Math.round(r.top)) + 'px');
        }
        ['load','resize','scroll'].forEach(ev => window.addEventListener(ev, computeInspectorTop, { passive: true }));
        // Also recompute after potential layout shifts in the app area
        const app = document.querySelector('.app');
        if (app) {
          const ro = new ResizeObserver(() => computeInspectorTop());
          ro.observe(app);
        }
        requestAnimationFrame(computeInspectorTop);
      })();
    </script>
    <script>
      // Lineage live filter for scrollable list
      (function(){
        const q = document.getElementById('lineageFilter');
        const list = document.getElementById('lineageList');
        if (!q || !list) return;
        function apply(){
          const needle = (q.value || '').toLowerCase();
          list.querySelectorAll('label').forEach(l => {
            const txt = l.textContent.toLowerCase();
            l.style.display = needle ? (txt.includes(needle) ? '' : 'none') : '';
          });
        }
        q.addEventListener('input', apply);
      })();
    </script>
    
  </body>
</html>
